#!/bin/bash
# 一鍵啟動所有 CUGA + AppWorld 所需服務

set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# 顏色定義
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}╔══════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  🚀 CUGA + AppWorld 完整環境啟動                 ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════════════╝${NC}"
echo ""

# 檢查虛擬環境
if [ ! -d ".venv" ]; then
    echo -e "${RED}❌ 錯誤: 找不到虛擬環境 .venv${NC}"
    exit 1
fi

# 檢查 appworld 目錄
if [ ! -d "appworld/data" ]; then
    echo -e "${RED}❌ 錯誤: 找不到 appworld/data 目錄${NC}"
    exit 1
fi

# 設定環境變數
export APPWORLD_ROOT="$SCRIPT_DIR/appworld"
echo -e "${GREEN}✅ APPWORLD_ROOT: $APPWORLD_ROOT${NC}"

# 啟用虛擬環境
source .venv/bin/activate

echo ""
echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${YELLOW}  啟動服務中...${NC}"
echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# 定義清理函數
cleanup() {
    echo ""
    echo -e "${YELLOW}正在停止所有服務...${NC}"
    pkill -P $$ || true
    exit 0
}

trap cleanup SIGINT SIGTERM

# 建立日誌目錄
LOG_DIR="$SCRIPT_DIR/logging/services"
mkdir -p "$LOG_DIR"

# 啟動 AppWorld Environment 服務 (Port 8000) - 先啟動
echo -e "${BLUE}[1/3]${NC} 啟動 AppWorld Environment (Port 8000)..."
cd "$APPWORLD_ROOT"
appworld serve environment --port 8000 > "$LOG_DIR/appworld_env.log" 2>&1 &
ENV_PID=$!
cd "$SCRIPT_DIR"
sleep 5

if kill -0 $ENV_PID 2>/dev/null; then
    echo -e "${GREEN}      ✅ AppWorld Environment 已啟動 (PID: $ENV_PID)${NC}"
else
    echo -e "${RED}      ❌ AppWorld Environment 啟動失敗${NC}"
    cat "$LOG_DIR/appworld_env.log"
    exit 1
fi

# 啟動 AppWorld API 服務 (Port 9000) - 次之
echo -e "${BLUE}[2/3]${NC} 啟動 AppWorld APIs (Port 9000)..."
cd "$APPWORLD_ROOT"
appworld serve apis --port 9000 > "$LOG_DIR/appworld_api.log" 2>&1 &
API_PID=$!
cd "$SCRIPT_DIR"
sleep 5

if kill -0 $API_PID 2>/dev/null; then
    echo -e "${GREEN}      ✅ AppWorld APIs 已啟動 (PID: $API_PID)${NC}"
else
    echo -e "${RED}      ❌ AppWorld APIs 啟動失敗${NC}"
    cat "$LOG_DIR/appworld_api.log"
    exit 1
fi

# 啟動 Registry 服務 (Port 8001) - 最後啟動（需要連接到 AppWorld APIs）
echo -e "${BLUE}[3/3]${NC} 啟動 Registry 服務 (Port 8001) - 使用 AppWorld API 配置..."
export MCP_SERVERS_FILE="$SCRIPT_DIR/src/cuga/backend/tools_env/registry/config/mcp_servers_appworld.yaml"
cuga start registry > "$LOG_DIR/cuga_registry.log" 2>&1 &
REGISTRY_PID=$!
sleep 3

if kill -0 $REGISTRY_PID 2>/dev/null; then
    echo -e "${GREEN}      ✅ Registry 服務已啟動 (PID: $REGISTRY_PID)${NC}"
else
    echo -e "${RED}      ❌ Registry 服務啟動失敗${NC}"
    cat "$LOG_DIR/cuga_registry.log"
    exit 1
fi

echo ""
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}  ✅ 所有服務已成功啟動！${NC}"
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
echo -e "${BLUE}╔══════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  📋 服務狀態                                      ║${NC}"
echo -e "${BLUE}╠══════════════════════════════════════════════════╣${NC}"
echo -e "${BLUE}║  ${GREEN}✅ Registry${NC}       http://localhost:8001       ${BLUE}║${NC}"
echo -e "${BLUE}║  ${GREEN}✅ Environment${NC}    http://localhost:8000       ${BLUE}║${NC}"
echo -e "${BLUE}║  ${GREEN}✅ APIs${NC}           http://localhost:9000       ${BLUE}║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "${YELLOW}💡 提示：${NC}"
echo -e "   • 在另一個終端執行評估命令"
echo -e "   • 例如: ${GREEN}python -m cuga.evaluation.evaluate_appworld run-task d0b1f43_2${NC}"
echo -e "   • 按 ${RED}Ctrl+C${NC} 停止所有服務"
echo ""
echo -e "${YELLOW}📝 日誌檔案位置：${NC}"
echo -e "   • Registry:    ${GREEN}logging/services/cuga_registry.log${NC}"
echo -e "   • Environment: ${GREEN}logging/services/appworld_env.log${NC}"
echo -e "   • APIs:        ${GREEN}logging/services/appworld_api.log${NC}"
echo ""
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}等待中...${NC} (服務保持運行)"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# 保持運行
wait
